---

- name: "node.js: fetch sources"
  sudo: yes
  sudo_user: jenkins
  get_url:
    url=http://nodejs.org/dist/v0.12.3/node-v0.12.3.tar.gz
    dest=/tmp/

- name: "node.js: Unpack tarball"
  sudo: yes
  sudo_user: jenkins
  command:
    tar zxf node-v0.12.3.tar.gz
    chdir=/tmp

- name: "node.js: lookup directory name"
  sudo: yes
  sudo_user: jenkins
  shell:
    ls /tmp | grep node-v | sort | head -n1
  register: node_dir

- name: "user: create .local folder"
  sudo: yes
  sudo_user: jenkins
  file:
    path=/home/jenkins/.local
    state=directory
    owner=jenkins
    group=jenkins

- name: "node.js: configure"
  sudo: yes
  sudo_user: jenkins
  shell:
    ./configure --prefix=/home/jenkins/.local
    chdir=/tmp/{{ node_dir.stdout }}

- name: "node.js: make"
  sudo: yes
  sudo_user: jenkins
  shell:
    /usr/bin/make
    chdir=/tmp/{{ node_dir.stdout }}

- name: "node.js: make install"
  sudo: yes
  sudo_user: jenkins
  shell:
    /usr/bin/make install
    chdir=/tmp/{{ node_dir.stdout }}

# this is only useful when connecting to a node, Jenkins needs another tweak
- name: "node.js: add nodejs on PATH"
  sudo: yes
  sudo_user: jenkins
  shell:
    echo "PATH=$PATH:/home/jenkins/.local/bin" >> /home/jenkins/.bashrc

- name: "node.js: clean up node install"
  sudo: yes
  sudo_user: jenkins
  shell:
    rm -rf /tmp/node-*

# XXX: This does not work. npm is installed for jenkins user only but requires root access:
#
# jenkins@node5:~$ npm install -g bower
# npm ERR! tar.unpack untar error /home/jenkins/.npm/bower/1.8.4/package.tgz
# npm ERR! Linux 4.4.0-127-generic
# npm ERR! argv "/home/jenkins/.local/bin/node" "/home/jenkins/.local/bin/npm" "install" "-g" "bower"
# npm ERR! node v0.12.3
# npm ERR! npm  v2.9.1
# npm ERR! path /home/jenkins/.local/lib/node_modules/bower
# npm ERR! code EACCES
# npm ERR! errno -13

# npm ERR! Error: EACCES, mkdir '/home/jenkins/.local/lib/node_modules/bower'
# npm ERR!     at Error (native)
# npm ERR!  { [Error: EACCES, mkdir '/home/jenkins/.local/lib/node_modules/bower']
# npm ERR!   errno: -13,
# npm ERR!   code: 'EACCES',
# npm ERR!   path: '/home/jenkins/.local/lib/node_modules/bower',
# npm ERR!   fstream_type: 'Directory',
# npm ERR!   fstream_path: '/home/jenkins/.local/lib/node_modules/bower',
# npm ERR!   fstream_class: 'DirWriter',
# npm ERR!   fstream_stack:
# npm ERR!    [ '/home/jenkins/.local/lib/node_modules/npm/node_modules/fstream/lib/dir-writer.js:36:23',
# npm ERR!      '/home/jenkins/.local/lib/node_modules/npm/node_modules/mkdirp/index.js:46:53',
# npm ERR!      'FSReqWrap.oncomplete (fs.js:95:15)' ] }
# npm ERR!
# npm ERR! Please try running this command again as root/Administrator.

# npm ERR! Please include the following file with any support request:
# npm ERR!     /home/jenkins/npm-debug.log

# - name: "node.js: install NPM packages"
#   sudo: yes
#   sudo_user: jenkins
#   npm:
#     name={{item}}
#     global=yes
#     state=present
#   with_items:
#     - bower
#     - jshint
#     - csslint
