---

- name: "node.js: check if it is installed"
  shell: /home/jenkins/.local/bin/node --version
  register: node_js_version
  ignore_errors: True

- name: "node.js: fetch sources"
  become: yes
  become_user: jenkins
  get_url:
    url=https://nodejs.org/dist/v4.4.7/node-v4.4.7-linux-x64.tar.xz
    checksum=sha256:f28beed1b553696c14af078e484439e7c0eb6510b5608235f60873ba238e3907
    dest=/tmp/
  when: node_js_version.stdout != 'v4.4.7'

- name: "node.js: unpack"
  become: yes
  become_user: jenkins
  unarchive: |
    src=/tmp/node-v4.4.7-linux-x64.tar.xz
    dest=/tmp
    copy=no
  when: node_js_version.stdout != 'v4.4.7'

- name: "node.js: delete .local folder"
  become: yes
  become_user: jenkins
  file:
    path=/home/jenkins/.local
    state=absent
    owner=jenkins
    group=jenkins
  when: node_js_version.stdout != 'v4.4.7'

- name: "node.js: create .local folder"
  become: yes
  become_user: jenkins
  file:
    path=/home/jenkins/.local
    state=directory
    owner=jenkins
    group=jenkins
  when: node_js_version.stdout != 'v4.4.7'

- name: "node.js: copy node to .local folder"
  become: yes
  become_user: jenkins
  shell: cp -r /tmp/node-v4.4.7-linux-x64/* /home/jenkins/.local/
  when: node_js_version.stdout != 'v4.4.7'

# this is only useful when connecting to a node, Jenkins needs another tweak
- name: "node.js: add nodejs on PATH"
  become: yes
  become_user: jenkins
  shell: |
    echo "PATH=$PATH:/home/jenkins/.local/bin" >> /home/jenkins/.bashrc
  when: node_js_version.stdout != 'v4.4.7'

- name: "node.js: install NPM packages"
  become: yes
  become_user: jenkins
  npm:
    name={{item}}
    global=yes
    state=present
  with_items:
    - bower
    - jshint
    - csslint
  when: node_js_version.stdout != 'v4.4.7'
